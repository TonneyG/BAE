<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebSocket Chat with XMPP</title>
</head>
<link rel="stylesheet" href="css/chat.css">
<body>
<h1>哈哈</h1>
<div class="panel">
	<input type="text" id="username" placeholder="用户名">
	<input type="password" id="password" placeholder="密码">
	<button id="connectButton">连接</button>
</div>

<div id="presenceArea" class="panel"></div>
<div id="chatArea" class="panel"></div>
<div id="output"></div>
</body>
<script src="js/strophe.js"></script>
<script>
	var output = document.getElementById("output");
	function log(message){
		var line = document.createElement("div");
		line.textContext = message;
		output.appendChild(line);
	}
	
	function connectHandler(cond){
		if(cond == Strophe.Status.CONNECTED){
			log("connected");
			connection.send($pres());
		}
	}
	
	var url = "ws://localhost:5280/";
	var connection = null;
	
	var connectButton = document.getElementById("connectButton");
	connectButton.onclick = function(){
		var username = document.getElementById("username");
		var password = document.getElementById("password");
		connection = new Strophe.Connection({
			proto:new Strophe.Websocket(url)
		});
		connection.connect(username,password,connectHandler);
	
		//Set up handlers
		connection.addHandler(messageHandler,null,"message","chat");
		connection.addHandler(presenceHandler,null,"presence",null);
		connection.addHandler(pingHandler,"urn:xmpp:ping","iq","get");
		
		//create presence update UI
		var presenceArea = document.getElementById("presenceArea");
		var sel = document.createElement("select");
		var availabilities = ["away","chat","dnd","xa"];
		var labels = ["Away","Available","Busy","Gone"];
		for(var i=0;i<availabilities.length;i++){
			var option = document.createElement("option");
			option.value = availabilities[i];
			option.text = labels[i];
			sel.add(option);
		}
		presenceArea.appendChild(sel);
		
		var statusInput = document.createElement("input");
		statusInput.setAttribute("placeholder","status");
		presenceArea.appendChild(statusInput);
		
		var statusButton = document.createElement("button");
		statusButton.textContent = "Update Status";
		statusButton.onClick = function(){
			var pres = $pres();
			c("show").t(sel.value).up();
			c("status").t(statusInput.value);
			connection.send(pres);
		}
		presenceArea.appendChild(statusButton);
		function presenceHandler(presence){
			var from = presence.getAttribute("from");
			var show = "";
			var status = "";
			Strophe.forEachChild(presence,"show",function(elem){
				show = elem.textContent;
			});
			Strophe.forEachChild(presence,"status",function(elem){
				status = elem.textContent;
			});
			if(show || status){
				log("[presence] "+from+":"+status+" "+show);
			}
			return true;
		}
		
		//create chat UI
		var chatArea = document.getElementById("chatArea");
		var toJid = document.getElementById("input");
		toJid.setAttribute("placeholder","user@Server");
		chatArea.appendChild(toJid);
		
		var chatBody = document.createElement("input");
		chatBody.setAttribute("placeholder","chat body");
		chatArea.appendChild(chatBody);
		
		var sendButton = document.createElement("button");
		sendButton.textContent = "Send";
		sendButton.onClick = function(){
			var message = $msg({to:toJid.value,type:"chat"}).c("body").t(chatBody.value);
			connection.send(message);
		}
		chatArea.appendChild(sendButton);
		
		function messageHandler(message){
			var from = message.getAttribute("from");
			var body = "";
			Strophe.forEachChild(message,"body",function(elem){
				body = elem.textContent;
			});
			
			//log message if body was present
			if(body){
				log(from+" : "+body);
			}
			return true;
		}
		
		function pingHandler(ping){
			var pingId = ping.getAttribute("id");
			var from = ping.getAttribute("from");
			var to = ping.getAttribute("to");
			
			var pong = $iq({type:"result",to:from,id:pingId,"from":to});
			connection.send(pong);
			
			return true;
		}
	}
</script>
</html>